{% set services = settings.dockers -%}
{% set secrets = settings.services -%}
{
  "admin": {
    "disabled": true,
    "config": {
      "persist": false
    }
  },
  "logging": {
    "logs": {
      "default": {
        "writer": {
          "output": "file",
          "filename": "/var/log/caddy/default.log"
        },
        "encoder": {
          "format": "console",
          "time_format": "rfc3339"
        },
        "level": "WARN"
      }
    }
  },
  "apps": {
    "http": {
      "servers": {
        "srvh1": {
          "listen": [":80"],
          "routes": [{
            "handle": [{
              "handler": "static_response",
              "headers": {
                "Location": ["https://{http.request.host}{http.request.uri}"]
              },
              "status_code": 301
            }]
          }],
          "protocols": ["h1"]
        },
        "srvh2": {
          "listen": [":7443"],
          "listener_wrappers": [{
            "wrapper": "proxy_protocol"
          },
          {
            "wrapper": "tls"
          },
          {
            "wrapper": "trojan"
          }],
          "routes": [{
            "match": [{
              "path": ["{{ secrets.xray.ws.path }}"],
              "header": {
                "Connection": ["*Upgrade*"],
                "Upgrade": ["websocket"]
              }
            }],
            "handle": [{
              "handler": "reverse_proxy",
              "upstreams": [{
                "dial": "xray:2001"
              }]
            }]
          },
          {
            "match": [{
              "path": ["{{ secrets.xray.h2c.path }}"]
            }],
            "handle": [{
              "handler": "reverse_proxy",
              "transport": {
                "protocol": "http",
                "versions": ["h2c","2"]
              },
              "upstreams": [{
                "dial": "xray:2005"
              }]
            }]
          },
          {
            "match": [{
              "protocol": "grpc",
              "path": ["{{ secrets.xray.grpc.service_name }}/*"]
            }],
            "handle": [{
              "handler": "reverse_proxy",
              "transport": {
                "protocol": "http",
                "versions": ["h2c","2"]
              },
              "upstreams": [{
                "dial": "xray:2011"
              }],
              "headers": {
              	"request": {
                  "set": {
                    "X-Real-IP": ["{http.vars.client_ip}"]
                  }
              	}
              }
            }]
          },
          {
            "handle": [{
              "handler": "forward_proxy",
              "auth_user_deprecated": "{{ secrets.xray.naive_proxy.user }}",
              "auth_pass_deprecated": "{{ secrets.xray.naive_proxy.password }}",
              "hide_ip": true,
              "hide_via": true,
              "probe_resistance": {}
            }]
          },
          {
            "handle": [{
              "handler": "trojan",
              "connect_method": true,
              "websocket": true
            }]
          },
          {
            "match": [{
              "host": ["{{ secrets.blog.domain }}"]
            }],
            "handle": [{
              "handler": "subroute",
              "routes": [{
                "handle": [{
                  "handler": "headers",
                  "response": {
                    "set": {
                      "Strict-Transport-Security": ["max-age=31536000; includeSubDomains; preload"]
                    }
                  }
                }]
              },
              {
                "handle": [{
                  "handler": "file_server",
                  "root": "/srv"
                }]
              }]
            }]
          }{%- if services.remark42.enabled %},
          {
            "match": [{
              "host": ["{{ secrets.remark42.domain }}"]
            }],
            "handle": [{
              "handler": "subroute",
              "routes": [{
                "handle": [{
                  "handler": "reverse_proxy",
                  "upstreams": [{
                    "dial": "remark42:8080"
                  }]
                }]
              }]
            }]
          }{%- endif %}{%- if services.freshrss.enabled %},
          {
            "match": [{
              "host": ["{{ secrets.freshrss.domain }}"]
            }],
            "handle": [{
              "handler": "subroute",
              "routes": [{
                "handle": [{
                  "handler": "reverse_proxy",
                  "upstreams": [{
                    "dial": "freshrss:80"
                  }]
                }]
              }]
            }]
          }{%- endif %}{%- if services.memos.enabled %},
          {
            "match": [{
              "host": ["{{ secrets.memos.domain }}"]
            }],
            "handle": [{
              "handler": "subroute",
              "routes": [{
                "handle": [{
                  "handler": "reverse_proxy",
                  "upstreams": [{
                    "dial": "memos:5230"
                  }]
                }]
              }]
            }]
          }{%- endif %}],
          "automatic_https": {
            "disable": true
          },
          "tls_connection_policies": [{
            "match": {
              "sni": [
                "{{ secrets.freshrss.domain }}"
                {%- if services.remark42.enabled %},"{{ secrets.remark42.domain }}"{%- endif %}
              ]
            },
            "protocol_min": "tls1.2",
            "protocol_max": "tls1.2",
            "cipher_suites": ["TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256"],
            "curves": ["secp521r1","secp384r1","secp256r1"]
          },
          {
            "match": {
              "sni": [
                "{{ secrets.blog.domain }}"
                ,"{{ secrets.memos.domain }}"
              ]
            },
            "cipher_suites": ["TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384","TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256","TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256"],
            "curves": ["x25519","secp521r1","secp384r1","secp256r1"]
          }],
          "protocols": ["h1","h2"]
        }
      }
    },
    "trojan": {
      "proxy": {
        "proxy": "no_proxy"
      },
      "upstream": {
        "upstream": "memory"
      },
      "users": [
        {% for name in secrets.xray.trojan.users %}
        "{{ name }}"{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    },
    "tls": {
      "certificates": {
        "automate": [
            "{{ secrets.blog.domain }}"
            {%- if services.memos.enabled %},"{{ secrets.memos.domain }}"{%- endif %}
            {%- if services.freshrss.enabled %},"{{ secrets.freshrss.domain }}"{%- endif %}
            {%- if services.remark42.enabled %},"{{ secrets.remark42.domain }}"{%- endif %}
        ]
      },
      "automation": {
        "policies": [{
          "issuers": [{
            "module": "acme",
            "email": "{{ settings.user.email }}"
          },
          {
            "module": "zerossl",
            "email": "{{ settings.user.email }}"
          }]
        }]
      }
    }
  }
}
